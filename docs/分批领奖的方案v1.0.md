# 产品需求变更：分批领取奖励功能

## 📋 需求背景

### 当前问题

用户反馈：长期质押的 NFT 无法领取奖励，系统提示 "Gas 超限" 错误。

**典型场景**：
- 用户 A：质押 180 天后尝试领取
- 用户 B：质押 365 天后尝试领取
- 用户 C：质押 3 年后尝试领取
- ❌ 结果：无法领取，提示错误

### 影响范围

- **影响用户**：长期质押的用户（超过 90 天未领取）
- **影响程度**：高（资产被锁定，无法领取）
- **紧急程度**：高（需要尽快解决）

---

## 🎯 解决方案

### 核心思路

实施 **分批领取机制**：
- 每次最多领取 90 天的奖励
- 超出 90 天的部分需要分多次领取
- 用户可以一次性选择多个 NFT 批量领取

### 为什么是 90 天？

基于技术性能和用户体验平衡：
- ✅ 保证领取成功（不会超时）
- ✅ 合理的奖励周期
- ✅ 提示用户定期领取

### BNB Chain 优化

**重要**: 不同区块链网络有不同的 Gas 限制！

| 网络 | Gas 限制 | 单次领取天数 | 原因 |
|-----|---------|------------|------|
| **以太坊** | 30,000,000 | **90 天** | 标准限制，确保安全 |
| **BNB Chain** | 100,000,000 | **300 天** | Gas 限制更高，可提高上限 ✅ |
| **Polygon** | 30,000,000 | 90 天 | 与以太坊相同 |

**BNB Chain 的优势**：
- Gas 限制是以太坊的 **3.33 倍**
- 可以一次领取更多天数的奖励
- 用户体验更好（操作次数更少）

**具体方案**：
- 以太坊：每次最多 90 天（4 次可领取 360 天）
- **BNB Chain：每次最多 300 天（2 次可领取 600 天）**

---

## 🌐 多链支持策略

### 不同链的用户体验

#### 以太坊用户
```
质押 180 天 → 分 2 次领取
- 第 1 次：90 CPOP（1-90天）
- 第 2 次：90 CPOP（91-180天）
```

#### BNB Chain 用户（优化）
```
质押 180 天 → 1 次完成！
- 一次领取：180 CPOP（1-180天）✅
```

```
质押 365 天 → 分 2 次领取（而非以太坊的 4 次）
- 第 1 次：300 CPOP（1-300天）
- 第 2 次：65 CPOP（301-365天）
```

### 产品实现建议

**前端自动识别链类型**：
```javascript
// 伪代码示例
const chainId = await provider.getNetwork().chainId;

let maxDaysPerClaim;
if (chainId === 56 || chainId === 97) { // BNB Chain
    maxDaysPerClaim = 300; // BNB Chain 可以领取更多
} else {
    maxDaysPerClaim = 90; // 以太坊等标准限制
}
```

**用户体验提示**：
```javascript
// 根据链类型显示不同提示
if (isBNBChain) {
    toast("✅ 检测到 BNB Chain，您可以一次领取 300 天的奖励！");
} else {
    toast("每次最多领取 90 天的奖励");
}
```

---

## 📱 产品功能设计

### 1. 单 NFT 领取流程

#### 场景 A: 质押 < 90 天

**用户体验**：
1. 点击 "领取奖励"
2. 显示奖励金额（例如：90 CPOP）
3. 点击确认
4. ✅ 一次领取完成

**提示文案**：
> "您有 90 天的奖励待领取（90 CPOP）"

#### 场景 B: 质押 90-180 天

**用户体验**：
1. 点击 "领取奖励"
2. 提示："您的奖励已累积 180 天，将分 2 次领取"
3. 显示每次领取的金额：
   - 第 1 次：90 CPOP（1-90 天）
   - 第 2 次：90 CPOP（91-180 天）
4. 点击"开始领取"
5. 自动分批领取（用户等待）
6. ✅ 显示完成

**交互方案**：
```
┌─────────────────────────────────────┐
│  领取奖励                            │
├─────────────────────────────────────┤
│                                     │
│  您已累积奖励：180 天              │
│  待领取总额：180 CPOP              │
│                                     │
│  将分 2 次领取：                    │
│  ┌─────────────────────────────┐   │
│  │ 第 1 次：90 CPOP (1-90天)   │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 第 2 次：90 CPOP (91-180天) │   │
│  └─────────────────────────────┘   │
│                                     │
│  [  取消  ]  [ 开始领取 ]          │
└─────────────────────────────────────┘
```

#### 场景 C: 质押 > 180 天

**用户体验**：
1. 点击 "领取奖励"
2. 提示："您的奖励已累积 365 天，将分 5 次领取"
3. 显示分批详情（可折叠/展开）
4. 用户可以选择：
   - 选项 A: "一次性领取所有批次"
   - 选项 B: "我只领取前 N 批"
5. 自动执行领取
6. ✅ 显示进度和结果

### 2. 批量 NFT 领取流程

#### 功能描述

用户可以选择多个 NFT，一次性领取所有 NFT 的奖励。

**界面设计**：
```
┌────────────────────────────────────┐
│  我的质押 NFT                       │
├────────────────────────────────────┤
│  ☑ NFT #1  - 待领取: 90 CPOP      │
│  ☑ NFT #2  - 待领取: 180 CPOP     │
│  ☐ NFT #3  - 待领取: 60 CPOP      │
│  ☑ NFT #4  - 待领取: 200 CPOP     │
│                                    │
│  已选择 3 个 NFT                   │
│  总奖励: 470 CPOP                  │
│                                    │
│  [ 取消 ]  [ 领取全部选中的 ]     │
└────────────────────────────────────┘
```

#### 分批逻辑

**智能分批**：
- 扫描每个选中的 NFT
- 计算每个 NFT 需要分几次领取
- 合并展示所有批次
- 自动分配 Gas 优先级

**示例**：
```
用户选择了 3 个 NFT：
- NFT #1: 90 天 → 需要 1 次
- NFT #2: 180 天 → 需要 2 次
- NFT #3: 200 天 → 需要 3 次

总计：6 次领取
显示：
┌─────────────────────────────────┐
│ NFT #1 第 1 次：90 CPOP        │
│ NFT #2 第 1 次：90 CPOP        │
│ NFT #2 第 2 次：90 CPOP        │
│ NFT #3 第 1 次：90 CPOP        │
│ NFT #3 第 2 次：90 CPOP        │
│ NFT #3 第 3 次：20 CPOP        │
├─────────────────────────────────┤
│ 总计：470 CPOP                  │
└─────────────────────────────────┘
```

---

## 💡 用户体验优化

### 1. 智能提示

#### 预警提示
当检测到 NFT 质押超过 60 天：
```
⚠️ 您的 NFT 已累积 90 天的奖励
建议尽快领取，避免需要多次操作
```

#### 分批说明
当需要分批领取时：
```
💡 分批领取说明：
由于技术限制，系统每次最多领取 90 天的奖励。
您可以一次性完成所有批次的领取，系统会自动处理。
预计时间：约 2 分钟
```

### 2. 进度显示

#### 领取进度条
```
正在领取...
┌─────────────────────────────────┐
│ ████████░░░░░░░░  2/6 批        │
│                                  │
│ NFT #1 - 第 1 次 (90 CPOP) ✅   │
│ NFT #2 - 第 1 次 (90 CPOP) ✅   │
│ NFT #2 - 第 2 次 (90 CPOP) ⏳   │
└─────────────────────────────────┘
```

#### 失败处理
```
❌ NFT #3 第 2 次领取失败
原因：网络问题
建议：重试此批次
[ 跳过 ]  [ 重试此批次 ]
```

### 3. 批量操作优化

#### 快捷操作

**"一键领取全部"** 按钮：
- 自动选择所有可领取的 NFT
- 智能计算最佳分批顺序
- 一键完成所有领取

**"分批预览"** 功能：
- 点击后显示所有批次的详细信息
- 用户可以调整（取消某些批次）
- 确认后开始领取

---

## 📊 用户影响分析

### 用户体验变化

#### 以太坊用户

| 用户类型 | 修改前 | 修改后 |
|---------|--------|--------|
| 短期质押（<90天） | ✅ 一次领取 | ✅ 一次领取（无变化） |
| 中期质押（90-180天） | ❌ 失败/超时 | ✅ 自动分 2 次 |
| 长期质押（>180天） | ❌ 完全无法领取 | ✅ 自动分批，顺利完成 |
| 批量操作 | ❌ 不支持 | ✅ 支持一键批量 |

#### BNB Chain 用户（优化）

| 用户类型 | 修改前 | BNB Chain 修改后 |
|---------|--------|-----------------|
| 短期质押（<90天） | ✅ 一次领取 | ✅ 一次领取（无变化） |
| 中期质押（90-300天） | ❌ 失败/超时 | ✅ **一次完成** 🎉 |
| 长期质押（300-600天） | ❌ 完全无法领取 | ✅ 自动分 2 次 |
| 超长期质押（>600天） | ❌ 完全无法领取 | ✅ 自动分批，顺利完成 |
| 批量操作 | ❌ 不支持 | ✅ 支持一键批量 |

**关键优势**：
- BNB Chain 用户可以一次领取更多天数
- 操作次数更少（例如 300 天的奖励在以太坊需要 4 次，BNB Chain 只需 1 次）
- 总 Gas 成本更低（BNB Chain 的 Gas 价格远低于以太坊）

### 预期效果

**正面效果**：
- ✅ 长期质押用户可以成功领取
- ✅ 不再出现"Gas 超限"错误
- ✅ 自动分批处理，用户友好
- ✅ 支持批量操作，提升效率

#### 不同链的体验对比

**质押 365 天的领取体验**：

| 链 | 领取次数 | 预计时间 | Gas 成本 |
|---|---------|---------|---------|
| 以太坊 | 4 次 | ~8 分钟 | ~$320 |
| **BNB Chain** | **2 次** ✅ | **~4 分钟** ✅ | **~$10** ✅ |

**质押 180 天的领取体验**：

| 链 | 领取次数 | 预计时间 | Gas 成本 |
|---|---------|---------|---------|
| 以太坊 | 2 次 | ~4 分钟 | ~$160 |
| **BNB Chain** | **1 次** 🎉 | **~2 分钟** 🎉 | **~$5** 🎉 |

**需要注意**：
- ⚠️ 以太坊：分批领取需要等待，建议每 60-90 天领取一次
- ⚠️ BNB Chain：可以更长时间领取一次，建议每 200-300 天领取一次
- 💡 BNB Chain 的总 Gas 费用远低于以太坊

---

## 🎨 界面设计方案

### 场景 1: 正常领取（< 90 天）

```
┌─────────────────────────────┐
│  NFT #1234                 │
│  等级：SSS                  │
│  质押时长：30 天           │
│                            │
│  待领取奖励                │
│  90 CPOP                   │
│                            │
│  [   领取    ]            │
└─────────────────────────────┘
```

### 场景 2: 需要分批（> 90 天）

```
┌─────────────────────────────┐
│  NFT #1234                 │
│  等级：SSS                  │
│  质押时长：180 天          │
│                            │
│  ⚠️ 您的奖励需要分批领取   │
│                            │
│  总计：180 天             │
│  分 2 次领取：            │
│                            │
│  📦 批次 1                │
│     1-90 天  |  90 CPOP   │
│                            │
│  📦 批次 2                │
│     91-180 天 |  90 CPOP  │
│                            │
│  [取消] [开始领取全部]     │
└─────────────────────────────┘
```

### 场景 3: 批量选择

```
┌─────────────────────────────┐
│  我的质押 NFT               │
├────────────────────────────┤
│  □ NFT #1  (C)  30 CPOP   │
│  ☑ NFT #2  (B)  90 CPOP   │
│  ☑ NFT #3  (A)  180 CPOP  │
│  □ NFT #4  (S)  200 CPOP  │
│                            │
│  已选 2 个 | 总 270 CPOP  │
│  将分 3 次领取            │
│                            │
│  [ 全选 ] [ 领取选中 ]    │
└─────────────────────────────┘
```

---

## ❓ FAQ

### Q1: 为什么要分批？

**A**: 长期质押（如 365 天）如果一次性领取，会导致系统计算负载过大，影响性能和用户资金安全。分批领取可以保证领取成功。

### Q2: 每 90 天的依据是什么？

**A**: 基于性能和用户体验的最佳平衡点。90 天既能保证领取成功，又不会让用户需要太多次操作。

### Q3: 用户可以只领取一部分吗？

**A**: 可以。用户可以只看前几批，剩余的下次再领取。但建议一次性领取全部。

### Q4: 分批会影响总奖励吗？

**A**: 不会。分批只是操作方式，总奖励金额完全相同。

### Q5: 需要支付额外的 Gas 费用吗？

**A**: 是的，分 N 次需要支付 N 次 Gas。但每次领取都会获得相应天数的奖励。

### Q6: BNB Chain 上有什么不同？

**A**: BNB Chain 的 Gas 限制更高（3.33 倍于以太坊），因此：
- **BNB Chain**: 可以一次领取 **300 天**的奖励
- **以太坊**: 一次最多领取 **90 天**的奖励

**实际例子**：
- 质押 365 天，在 BNB Chain 上分 2 次领取（而非以太坊的 4 次）
- 质押 180 天，在 BNB Chain 上 1 次完成（以太坊需要 2 次）

### Q7: 系统会自动识别网络吗？

**A**: 是的，系统会自动检测链类型：
- 在 BNB Chain 上：单次领取上限 300 天
- 在其他链上：单次领取上限 90 天

---

## 📋 总结

### 核心需求

实现智能分批领取奖励功能，解决长期质押用户无法领取的问题。

### 关键特性

1. **以太坊网络**：每次最多领取 90 天
2. **BNB Chain 网络**：每次最多领取 300 天（Gas 限制更高）
3. **自动识别链类型**：系统自动适应不同网络
4. **批量操作支持**：可一次性领取多个 NFT
5. **智能分批提示**：清晰显示需要分几次领取

### 用户体验提升

| 场景 | 以太坊 | BNB Chain |
|-----|--------|-----------|
| 180 天质押 | 分 2 次 | 1 次完成 🎉 |
| 365 天质押 | 分 4 次 | 分 2 次 🎉 |
| Gas 成本 | 高 | 极低 🎉 |
| 操作时间 | 较长 | 较短 🎉 |

### 实施优先级

**P0（必须）**：
- 单 NFT 分批领取
- 链类型自动识别
- 分批提示和说明

**P1（重要）**：
- 批量选择 NFT
- 进度显示优化
- BNB Chain 优化

**P2（可选）**：
- 领取历史记录
- 预测下次领取时间
- 高级统计功能