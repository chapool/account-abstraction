# Staking åˆçº¦æ—¶é—´æ§åˆ¶åŠŸèƒ½æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

ä¸º Staking åˆçº¦æ·»åŠ å¯æ§åˆ¶çš„æ—¶é—´æˆ³åŠŸèƒ½ï¼Œæ–¹ä¾¿æµ‹è¯•æ—¶é—´ç›¸å…³çš„è´¨æŠ¼é€»è¾‘ï¼Œæ— éœ€ç­‰å¾…çœŸå®æ—¶é—´æµé€ã€‚

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. åˆçº¦ä¿®æ”¹ï¼ˆStaking.solï¼‰

#### æ–°å¢å­˜å‚¨å˜é‡
```solidity
bool public testMode;           // æ˜¯å¦å¯ç”¨æµ‹è¯•æ¨¡å¼
uint256 public testTimestamp;   // æµ‹è¯•æ¨¡å¼ä¸‹çš„æ—¶é—´æˆ³
```

#### æ–°å¢æ ¸å¿ƒå‡½æ•°

1. **å†…éƒ¨æ—¶é—´è·å–å‡½æ•°**
   ```solidity
   function _getCurrentTimestamp() internal view returns (uint256)
   ```
   - æ ¹æ® testMode è¿”å›æµ‹è¯•æ—¶é—´æˆ³æˆ–çœŸå®åŒºå—æ—¶é—´æˆ³

2. **æµ‹è¯•æ¨¡å¼ç®¡ç†å‡½æ•°**
   ```solidity
   function enableTestMode(uint256 initialTimestamp) external onlyOwner
   function disableTestMode() external onlyOwner
   function setTestTimestamp(uint256 timestamp) external onlyOwner
   ```

3. **æ—¶é—´å¿«è¿›å‡½æ•°**
   ```solidity
   function fastForwardTime(uint256 seconds_) external onlyOwner
   function fastForwardDays(uint256 days_) external onlyOwner
   function fastForwardMinutes(uint256 minutes_) external onlyOwner
   ```

#### å…¨å±€æ›¿æ¢
å°†åˆçº¦ä¸­æ‰€æœ‰ `block.timestamp` æ›¿æ¢ä¸º `_getCurrentTimestamp()`ï¼Œæ¶‰åŠä»¥ä¸‹åœºæ™¯ï¼š
- è´¨æŠ¼æ—¶è®°å½•æ—¶é—´
- é¢†å–å¥–åŠ±æ—¶æ›´æ–°æ—¶é—´
- å–æ¶ˆè´¨æŠ¼æ—¶è®¡ç®—æ—¶é—´
- å¥–åŠ±è®¡ç®—ä¸­çš„æ—¶é—´åˆ¤æ–­
- ç»„åˆçŠ¶æ€çš„æ¬¡æ—¥ç”Ÿæ•ˆæœºåˆ¶
- å†å²è°ƒæ•´è®°å½•

### 2. ç®¡ç†è„šæœ¬

åˆ›å»ºäº† 4 ä¸ªç®¡ç†è„šæœ¬ï¼š

#### enable-test-mode.ts
- å¯ç”¨æµ‹è¯•æ¨¡å¼
- è®¾ç½®åˆå§‹æµ‹è¯•æ—¶é—´æˆ³
- æ˜¾ç¤ºå½“å‰çŠ¶æ€

#### fast-forward-time.ts  
- å¿«è¿›æŒ‡å®šæ—¶é—´ï¼ˆæ”¯æŒåˆ†é’Ÿã€å¤©ã€ç§’ï¼‰
- æ˜¾ç¤ºå¿«è¿›å‰åçš„æ—¶é—´å¯¹æ¯”
- å‚æ•°ï¼š`--minutes`, `--days`, `--seconds`

#### check-time-status.ts
- æŸ¥çœ‹å½“å‰æ—¶é—´çŠ¶æ€
- å¯¹æ¯”æµ‹è¯•æ—¶é—´å’ŒçœŸå®æ—¶é—´
- æ˜¾ç¤ºå¯ç”¨æ“ä½œæç¤º

#### disable-test-mode.ts
- ç¦ç”¨æµ‹è¯•æ¨¡å¼
- æ¢å¤ä½¿ç”¨çœŸå®æ—¶é—´
- é‡ç½®æµ‹è¯•æ—¶é—´æˆ³

### 3. æ–‡æ¡£

#### Staking-Test-Mode-Guide.md
å®Œæ•´çš„ä½¿ç”¨æŒ‡å—ï¼ŒåŒ…å«ï¼š
- åŠŸèƒ½è¯´æ˜
- ä½¿ç”¨åœºæ™¯ç¤ºä¾‹
- è„šæœ¬è¯´æ˜
- å®Œæ•´æµ‹è¯•æµç¨‹
- å¸¸è§é—®é¢˜è§£ç­”
- æŠ€æœ¯ç»†èŠ‚

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬æµç¨‹

```bash
# 1. å¯ç”¨æµ‹è¯•æ¨¡å¼
npx hardhat run scripts/enable-test-mode.ts --network sepolia

# 2. è´¨æŠ¼ NFTï¼ˆä½¿ç”¨ç°æœ‰è„šæœ¬ï¼‰
# ...

# 3. å¿«è¿› 180 åˆ†é’Ÿï¼ˆæ¨¡æ‹Ÿ SSS çº§å®Œæ•´è¡°å‡å‘¨æœŸï¼‰
npx hardhat run scripts/fast-forward-time.ts --network sepolia -- --minutes 180

# 4. æŸ¥çœ‹å¥–åŠ±
npx hardhat run scripts/test-user-daily-rewards.ts --network sepolia

# 5. ç¦ç”¨æµ‹è¯•æ¨¡å¼
npx hardhat run scripts/disable-test-mode.ts --network sepolia
```

### é…åˆ StakingConfig ä½¿ç”¨

```bash
# ç¬¬ä¸€æ­¥ï¼šè®¾ç½®æµ‹è¯•ç¯å¢ƒ
npx hardhat run scripts/update-staking-config-for-testing.ts --network sepolia
npx hardhat run scripts/enable-test-mode.ts --network sepolia

# ç¬¬äºŒæ­¥ï¼šè¿›è¡Œæµ‹è¯•
# ... è´¨æŠ¼ã€å¿«è¿›æ—¶é—´ã€é¢†å–å¥–åŠ±ç­‰ ...

# ç¬¬ä¸‰æ­¥ï¼šæ¢å¤ç”Ÿäº§ç¯å¢ƒ
npx hardhat run scripts/disable-test-mode.ts --network sepolia
npx hardhat run scripts/restore-staking-config-production.ts --network sepolia
```

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. å®‰å…¨æ€§
- âœ… åªæœ‰ owner å¯ä»¥æ§åˆ¶æµ‹è¯•æ¨¡å¼
- âœ… æ—¶é—´åªèƒ½å‘å‰ï¼Œä¸èƒ½å€’é€€
- âœ… æµ‹è¯•æ¨¡å¼ä¸å½±å“å…¶ä»–åˆçº¦
- âœ… å¯ä»¥éšæ—¶ç¦ç”¨æ¢å¤æ­£å¸¸

### 2. çµæ´»æ€§
- âœ… æ”¯æŒç§’ã€åˆ†é’Ÿã€å¤©ä¸‰ç§æ—¶é—´å•ä½
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶æ—¶é—´ç‚¹
- âœ… å¯ä»¥æŸ¥çœ‹æ—¶é—´çŠ¶æ€
- âœ… æ”¯æŒå¤šæ¬¡å¿«è¿›

### 3. å…¼å®¹æ€§
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å·²è´¨æŠ¼çš„ NFT æ­£å¸¸å·¥ä½œ
- âœ… æ‰€æœ‰å¥–åŠ±è®¡ç®—é€»è¾‘ä¸å˜
- âœ… å¯ä»¥æ— ç¼åˆ‡æ¢æµ‹è¯•/ç”Ÿäº§æ¨¡å¼

## ğŸ§ª æµ‹è¯•åœºæ™¯è¦†ç›–

ç°åœ¨å¯ä»¥å¿«é€Ÿæµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

### 1. è¡°å‡æœºåˆ¶ï¼ˆPhase-based Decayï¼‰
- SSS çº§ï¼š180 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ
- SS çº§ï¼š90 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ
- S çº§ï¼š60 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ
- A çº§ï¼š45 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ
- B çº§ï¼š30 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ
- C çº§ï¼š20 åˆ†é’Ÿ â†’ å®Œæ•´è¡°å‡å‘¨æœŸ

### 2. æŒç»­è´¨æŠ¼å¥–åŠ±
- 30 å¤© â†’ 30 åˆ†é’Ÿï¼š10% å¥–åŠ±
- 90 å¤© â†’ 90 åˆ†é’Ÿï¼š20% å¥–åŠ±

### 3. ç»„åˆå¥–åŠ±
- 3 NFTï¼š7 åˆ†é’Ÿ â†’ 5% å¥–åŠ±ï¼ˆæ¬¡æ—¥ç”Ÿæ•ˆï¼‰
- 5 NFTï¼š15 åˆ†é’Ÿ â†’ 10% å¥–åŠ±ï¼ˆæ¬¡æ—¥ç”Ÿæ•ˆï¼‰
- 10 NFTï¼š30 åˆ†é’Ÿ â†’ 20% å¥–åŠ±ï¼ˆæ¬¡æ—¥ç”Ÿæ•ˆï¼‰

### 4. æå‰å–æ¶ˆæƒ©ç½š
- 7 åˆ†é’Ÿå†…å–æ¶ˆ â†’ 50% æƒ©ç½š

### 5. å­£åº¦è°ƒæ•´
- å¯ä»¥å¿«è¿›åˆ°ä¸‹ä¸€ä¸ªå­£åº¦
- æµ‹è¯•å†å²è°ƒæ•´è®°å½•åŠŸèƒ½

## ğŸ“ æ–‡ä»¶æ¸…å•

### åˆçº¦ä¿®æ”¹
- `contracts/CPNFT/Staking.sol` - æ·»åŠ æ—¶é—´æ§åˆ¶åŠŸèƒ½

### æ–°å¢è„šæœ¬
- `scripts/enable-test-mode.ts` - å¯ç”¨æµ‹è¯•æ¨¡å¼
- `scripts/fast-forward-time.ts` - å¿«è¿›æ—¶é—´
- `scripts/check-time-status.ts` - æŸ¥çœ‹æ—¶é—´çŠ¶æ€
- `scripts/disable-test-mode.ts` - ç¦ç”¨æµ‹è¯•æ¨¡å¼

### æ–‡æ¡£
- `docs/Staking-Test-Mode-Guide.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `TIME_CONTROL_SUMMARY.md` - æœ¬æ–‡ä»¶

## ğŸ“ æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‰å‡†å¤‡
```bash
# æ£€æŸ¥å½“å‰çŠ¶æ€
npx hardhat run scripts/check-time-status.ts --network sepolia

# å¦‚æœå·²å¯ç”¨ï¼Œå…ˆç¦ç”¨
npx hardhat run scripts/disable-test-mode.ts --network sepolia

# é‡æ–°å¯ç”¨è·å¾—å¹²å‡€çš„æµ‹è¯•ç¯å¢ƒ
npx hardhat run scripts/enable-test-mode.ts --network sepolia
```

### 2. æµ‹è¯•ä¸­
```bash
# éšæ—¶æŸ¥çœ‹æ—¶é—´çŠ¶æ€
npx hardhat run scripts/check-time-status.ts --network sepolia

# åˆ†æ­¥å¿«è¿›ï¼Œè§‚å¯Ÿæ¯ä¸ªé˜¶æ®µçš„å˜åŒ–
npx hardhat run scripts/fast-forward-time.ts --network sepolia -- --minutes 30
# æŸ¥çœ‹å¥–åŠ±...
npx hardhat run scripts/fast-forward-time.ts --network sepolia -- --minutes 30
# å†æ¬¡æŸ¥çœ‹å¥–åŠ±...
```

### 3. æµ‹è¯•å
```bash
# åŠ¡å¿…ç¦ç”¨æµ‹è¯•æ¨¡å¼
npx hardhat run scripts/disable-test-mode.ts --network sepolia

# å¦‚æœä¿®æ”¹äº† StakingConfigï¼Œä¹Ÿè¦æ¢å¤
npx hardhat run scripts/restore-staking-config-production.ts --network sepolia
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**
   - æµ‹è¯•æ¨¡å¼ä»…ä¾›æµ‹è¯•ä½¿ç”¨
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿æŒç¦ç”¨çŠ¶æ€
   - éƒ¨ç½²æ—¶é»˜è®¤ä¸ºç¦ç”¨

2. **æ—¶é—´é™åˆ¶**
   - æ—¶é—´åªèƒ½å‘å‰
   - ä¸èƒ½è®¾ç½®ä¸ºè¿‡å»
   - å¦‚éœ€é‡ç½®ï¼Œå…ˆç¦ç”¨å†å¯ç”¨

3. **æƒé™æ§åˆ¶**
   - åªæœ‰ owner å¯ä»¥æ“ä½œ
   - ç¡®ä¿ç§é’¥å®‰å…¨
   - å®šæœŸæ£€æŸ¥çŠ¶æ€

4. **ä¸å…¶ä»–åˆçº¦çš„äº¤äº’**
   - æµ‹è¯•æ—¶é—´åªå½±å“ Staking åˆçº¦
   - å…¶ä»–åˆçº¦ä»ä½¿ç”¨çœŸå®æ—¶é—´
   - æ³¨æ„è·¨åˆçº¦äº¤äº’çš„æ—¶é—´ä¸€è‡´æ€§

## ğŸš€ æ•ˆç‡æå‡

### ä¹‹å‰ï¼ˆæ— æ—¶é—´æ§åˆ¶ï¼‰
- æµ‹è¯• 180 å¤©è¡°å‡ï¼šéœ€è¦ç­‰å¾… **6 ä¸ªæœˆ**
- æµ‹è¯• 90 å¤©æŒç»­å¥–åŠ±ï¼šéœ€è¦ç­‰å¾… **3 ä¸ªæœˆ**
- æµ‹è¯•ç»„åˆå¥–åŠ±æ¬¡æ—¥ç”Ÿæ•ˆï¼šéœ€è¦ç­‰å¾… **1-3 å¤©**

### ç°åœ¨ï¼ˆæœ‰æ—¶é—´æ§åˆ¶ï¼‰
- æµ‹è¯• 180 å¤©è¡°å‡ï¼šåªéœ€ **3 å°æ—¶**ï¼ˆ180 åˆ†é’Ÿï¼‰
- æµ‹è¯• 90 å¤©æŒç»­å¥–åŠ±ï¼šåªéœ€ **1.5 å°æ—¶**ï¼ˆ90 åˆ†é’Ÿï¼‰
- æµ‹è¯•ç»„åˆå¥–åŠ±æ¬¡æ—¥ç”Ÿæ•ˆï¼šåªéœ€ **å‡ åˆ†é’Ÿ**

**æ•ˆç‡æå‡ï¼šä»æ•°æœˆç¼©çŸ­åˆ°æ•°å°æ—¶ï¼** ğŸ‰

## ğŸ”® æœªæ¥æ‰©å±•

å¯èƒ½çš„å¢å¼ºåŠŸèƒ½ï¼š
- [ ] æ·»åŠ æ—¶é—´å¿«ç…§åŠŸèƒ½
- [ ] æ”¯æŒæ‰¹é‡æ—¶é—´æ“ä½œ
- [ ] æ·»åŠ æ—¶é—´å›é€€åŠŸèƒ½ï¼ˆä»…é™æµ‹è¯•ç¯å¢ƒï¼‰
- [ ] é›†æˆåˆ°è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶
- [ ] æ·»åŠ æ—¶é—´äº‹ä»¶æ—¥å¿—

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒï¼š
- ä½¿ç”¨æŒ‡å—ï¼š`docs/Staking-Test-Mode-Guide.md`
- åˆçº¦ä»£ç ï¼š`contracts/CPNFT/Staking.sol`
- ç¤ºä¾‹è„šæœ¬ï¼š`scripts/enable-test-mode.ts` ç­‰

---

**åˆ›å»ºæ—¥æœŸï¼š** 2024-10-20  
**ç‰ˆæœ¬ï¼š** 1.0.0  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶å¯ç”¨

